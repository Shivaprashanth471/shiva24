on:
  push:
    branches:
      - dev        # The default branch
      - branch-* 
name: Main Workflow
jobs:
  sonarQubeTrigger:
    name: SonarQube Trigger
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    # - name: Install npm dependencies
    #   run: npm install

    - name: Check out my other private repo
      uses: actions/checkout@master
      with:
        repository: tericsoft-services/vitawerks_automation 
        token: ${{ secrets.my_pat }}
    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11
    - name: Cache Maven packages
      uses: actions/cache@v1
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    - name: list
      run: |
         mvn test -Dtest=Pipeline1_Api_Smoke  
    - name: reports
      run: |
        cd reports

    - name: building docker images for changed microservices
      id: check_files
      run: |
        echo "=============== list of modified files ==============="
        git diff --name-only HEAD^ HEAD
        echo "======================================================"
        git diff --name-only HEAD^ HEAD > files.txt
        filename=folder.txt
        cat > $filename
        flag=0
        while IFS= read -r file
        do
          if [[ $file == reports/* ]]; then
            if grep -q "reports" "$filename"; then
              echo "already exists"
            else
              echo  -e "reports" >> folder.txt
    # - name: scp
    #   run: scp -r /home/runner/work/shiva24/shiva24/reports/* ubuntu@3.6.47.66:/var/www/
    - name: deploy to server
      uses: AEnterprise/rsync-deploy@v1.0
      env:
        DEPLOY_KEY: ${{ secrets.ACL_PEM }}
        ARGS: "-e -c -r --delete"
        SERVER_PORT: 22
        FOLDER: reports
        SERVER_IP: ${{ secrets.ACL_IP }}
        USERNAME: ubuntu
        SERVER_DESTINATION: /var/www/test2/
    - name: checkout to our code 
      uses: actions/checkout@master
    - name: ls
      run: ls
    - name: Slack - Github Action
      uses: keithalpichi/slack-action@0.0.6

      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      with:
        template: 
        icon_url: test2.teric.services/reports/${{ steps.check_files.outputs.reports }}/${{ steps.check_files.outputs.reports }}/

        
    

 
    # - name: Check out my other private repo
    #   uses: actions/checkout@master
    #   with:
    #     repository: tericsoft-services/vitawerks_automation 
    #     token: ${{ secrets.my_pat }}    
           
    # - uses: actions/checkout@master
    #   with:
    #     name: tericsoft-services/vitawerks_automation     
    #     run: |
    #       maven install
    #       mvn test -Dtest=Pipeline1_Api_Smoke mvn test -Dtest=Pipeline1_Web_Smoke


       
    # - name: SonarQube Scan
    #   uses: kitabisa/sonarqube-action@v1.1.0
    #   with:
    #     host: ${{ secrets.SONARQUBE_HOST }}
    #     token: ${{ secrets.SONAR_TOKEN}}
    #     # path: ${{secrets.SONAR_PATH}}
    #     key: ${{secrets.SONAR_PROJECTKEY}}
    #     login: ${{secrets.SONAR_LOGIN}}
    #     password: ${{secrets.SONAR_PASSWORD}}