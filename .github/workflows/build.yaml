on:
  push:
    branches:
      - dev        # The default branch
      - branch-* 
name: Main Workflow
jobs:
  sonarQubeTrigger:
    name: SonarQube Trigger
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    # - name: Install npm dependencies
    #   run: npm install

    - name: Check out my other private repo
      uses: actions/checkout@master
      with:
        repository: tericsoft-services/vitawerks_automation 
        token: ${{ secrets.my_pat }}
    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11
    - name: Cache Maven packages
      uses: actions/cache@v1
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    - name: list
      run: |
        mvn test -Dtest=Pipeline1_Api_Smoke 
    
    - name: deploy to server
      uses: AEnterprise/rsync-deploy@v1.0
      env:
        DEPLOY_KEY: ${{ secrets.ACL_PEM }}
        ARGS: "-e -c -r --delete"
        SERVER_PORT: 22
        FOLDER: reports
        SERVER_IP: ${{ secrets.ACL_IP }}
        USERNAME: ubuntu
        SERVER_DESTINATION: /var/www/test2/
      - name: run script
        id: testreports
        run: | 
          for dir1 in ./reports/* 
          do 
            var1=$(basename "$dir1")
            echo '::set-output name=date::var1'
          done
          for dir2 in $dir1/* 
          do 
            var2=$(basename "$dir2")
            echo '::set-output name=timestamp::var2'
          done
      
 
    - name: run  script in the server
      uses: garygrossgarten/github-action-ssh@release
      with:
        command: |
          cd /var/www/test2/
          sh reports.sh
        host: ${{ secrets.ACL_IP}}
        username: ubuntu
        privateKey: ${{ secrets.ACL_PEM}}

    # - name: checkout to our code 
    #   uses: actions/checkout@master
    # - name: ls
    #   run: ls 
    - name: run  script in the server
      uses: garygrossgarten/github-action-ssh@release
      with:
        command: |
          cd /var/www/test2/
          sh reports.sh
        host: ${{ secrets.ACL_IP}}
        username: ubuntu
        privateKey: ${{ secrets.ACL_PEM}}



    - name: Slack - Github Action
      uses: keithalpichi/slack-action@0.0.6
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      with:
        template: plain
        icon_url: test2.teric.services/reports/${{ steps.testreports.outputs.date }}/${{ steps.testreports.outputs.timestamp }}/

        
    

 
    # - name: Check out my other private repo
    #   uses: actions/checkout@master
    #   with:
    #     repository: tericsoft-services/vitawerks_automation 
    #     token: ${{ secrets.my_pat }}    
           
    # - uses: actions/checkout@master
    #   with:
    #     name: tericsoft-services/vitawerks_automation     
    #     run: |
    #       maven install
    #       mvn test -Dtest=Pipeline1_Api_Smoke mvn test -Dtest=Pipeline1_Web_Smoke


       
    # - name: SonarQube Scan
    #   uses: kitabisa/sonarqube-action@v1.1.0
    #   with:
    #     host: ${{ secrets.SONARQUBE_HOST }}
    #     token: ${{ secrets.SONAR_TOKEN}}
    #     # path: ${{secrets.SONAR_PATH}}
    #     key: ${{secrets.SONAR_PROJECTKEY}}
    #     login: ${{secrets.SONAR_LOGIN}}
    #     password: ${{secrets.SONAR_PASSWORD}}